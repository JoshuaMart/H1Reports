{
  "id": 732431,
  "global_id": "Z2lkOi8vaGFja2Vyb25lL1JlcG9ydC83MzI0MzE=",
  "url": "https://hackerone.com/reports/732431",
  "title": "Improper integrity protection of server-side encryption keys",
  "state": "Closed",
  "substate": "resolved",
  "severity_rating": "high",
  "readable_substate": "Resolved",
  "created_at": "2019-11-08T14:19:09.158Z",
  "submitted_at": "2019-11-08T14:19:09.158Z",
  "is_member_of_team?": false,
  "is_organization_group_member?": false,
  "reporter": {
    "disabled": false,
    "username": "yahe",
    "url": "/yahe",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98"
    },
    "is_me?": false,
    "cleared": false,
    "verified": false,
    "hackerone_triager": false,
    "hacker_mediation": false
  },
  "team": {
    "id": 13291,
    "url": "https://hackerone.com/nextcloud",
    "handle": "nextcloud",
    "profile_picture_urls": {
      "small": "https://profile-photos.hackerone-user-content.com/variants/tnqlkt8d6fcch8hj8brdjp8nw864/d3dc6b2d7e2dc3657e8861b0d7e2dfca1a6d513dd784c613f4e56738907cea98",
      "medium": "https://profile-photos.hackerone-user-content.com/variants/tnqlkt8d6fcch8hj8brdjp8nw864/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
    },
    "permissions": [

    ],
    "submission_state": "open",
    "default_currency": "usd",
    "awards_miles": false,
    "offers_bounties": true,
    "state": "public_mode",
    "only_cleared_hackers": false,
    "pentest_feature_enabled?": false,
    "profile": {
      "name": "Nextcloud",
      "twitter_handle": "nextclouders",
      "website": "https://nextcloud.com",
      "about": "Access, share and protect your files, calendars, contacts, communication & more at home and in your enterprise."
    }
  },
  "has_bounty?": false,
  "in_validation?": false,
  "can_view_team": true,
  "can_view_report": true,
  "is_external_bug": false,
  "is_published": false,
  "is_participant": false,
  "has_collaborators": false,
  "submitted_by_team_member": false,
  "stage": 4,
  "public": true,
  "visibility": "full",
  "cve_ids": [
    "CVE-2020-8259"
  ],
  "singular_disclosure_disabled": false,
  "disclosed_at": "2020-11-13T14:39:41.163Z",
  "bug_reporter_agreed_on_going_public_at": "2020-11-06T16:20:55.661Z",
  "team_member_agreed_on_going_public_at": "2020-11-13T14:39:41.069Z",
  "comments_closed?": false,
  "facebook_team?": false,
  "team_private?": false,
  "vulnerability_information": "The public keys used for the server-side encryption are not integrity-protected. These can easily replaced by anyone who has access to the data-at-rest data (even when the per-user-keys are enabled, as described in https://nextcloud.com/security/threat-model/). This holds true for all key types - from the master key, the per-user-keys as well as for the (optional) recovery key.\n\nAttack scenarios may look like this:\n* A recovery key is set by the admin and users enabled the recovery feature (or it was mandatorily set by adding the corresponding configuration to the `oc_preferences` table for all users). As it is unlikely that the recovery key is used very often, a person that has access to the data directory (even if at rest) is able to replace the public recovery key with a newly generated one. Each newly added file and each modified file will also be encrypted for the newly generated recovery key.\n* A per-user-key encryption scheme is introduced and organizational shared folders are set up. To better handle access management all organizational shared folders are owned by the admin that also handles access management requests. As it is unlikely that the admin account will be used to access the individual files, a person that has access to the data directory (even if at rest) is able to replace the public key of the admin account with a newly generated one. Each newly added file and each modified file that is put into any of the organizational shared folders will also be encrypted for the newly generated admin account key.\n\nThe mentioned attack scenarios may also be executed by an external storage provider if the folder that is used as the data directory is stored at this external storage provider. Administrative access to the actual Nextcloud server is **not** necessary to mount this attack.\n\n## Impact\n\nAfter mounting the attack the person would be able to read and modify all newly created files as well as files that have been modified since the attack was launched.\n\n**Preventing** this attack could look as follows:\n* The fingerprints of public and private key files that have been generated by the application could be stored in the database.\n* Whenever public or private key files are read from disk the fingerprint of that file is checked against the value stored in the database.\n\nAn alternative approach for **preventing** this attack could look as follows:\n* For each public and private key file that has been generated by the application a MAC could be calculated.\n* The key for the MAC could be derived from the instance id, the instance secret and the relative file name of the corresponding key file.\n* The MAC could be stored directly in the corresponding key file.\n* Whenever a public or private key file is read from disk the MAC of that file could be calculated and compared with the MAC stored in the file.",
  "weakness": {
    "id": 87,
    "name": "Insufficiently Protected Credentials"
  },
  "original_report_id": null,
  "original_report_url": null,
  "attachments": [
    {
      "id": 629444,
      "file_name": "nextcloud_poc2.mp4",
      "expiring_url": "https://hackerone-us-west-2-production-attachments.s3.us-west-2.amazonaws.com/PjFBrEUnQkTfJKLf7Bk9GTHH?response-content-disposition=attachment%3B%20filename%3D%22nextcloud_poc2.mp4%22%3B%20filename%2A%3DUTF-8%27%27nextcloud_poc2.mp4&response-content-type=video%2Fmp4&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQSL26QVWJ%2F20230923%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20230923T072114Z&X-Amz-Expires=341&X-Amz-Security-Token=IQoJb3JpZ2luX2VjECoaCXVzLXdlc3QtMiJGMEQCIGsYX%2B2SBOyOVYF%2Bbhi8FJSYZBaFBWa1bRzT%2Be3B%2FZjKAiAhOYWk%2Foi9Uzlh7TDqFekha1XoJLvg7HRX6M15Zy7OgyqyBQgiEAMaDDAxMzYxOTI3NDg0OSIMMFtgJWJNe1jj9nkVKo8F8Rs2Uaqvx6JwF6x1kZKjsrSeZ6cQNBwN5Wb9hls0EDyKQtSi4OIwgPbnTQubX83nd5ah2LnVEbBjw%2FeWeXliDAl%2FvcfL7Jr%2Bw%2B9Zt%2FJIPwgok0yh0yrBt%2FMHKf6jKyg1HXYfn1nmhzeOD2d2QJDCj5sOXpB7wiW08myHF2gOX%2FhtSISZCSevxv8fM25ODarqeeS4hfv%2BLEDgbFHbbT4E1NfuF8ED2tZiBSFh5%2B5GRH9tDuQNiRc11PuPiSwjorAQR%2BvNEGNjQmE4t1MC7CZ%2FcXGauTAzCS%2Fc%2Bwn34cAFOc2Tg5jVrz6xBNrLQkxxdjHvIBsqLMrTz%2FQ1LCnEECdd957bMTmgqAVSbGeqK2LjKaZ7j4m37weF8D66L%2Fffl0dc0inkPwRnTr0ZTF3%2FEIXdlA2Vp1lgDGet58F%2BpNSEEcSdhnS7xtwxDjXz7C3kS7O6OfaRyAO8ZJGUZmveDph6o2cw%2FPsTphMY2pbm6Pkz07sTZkxdV2fxo92Zo9qpNDPWqHn3gm%2BKAywtq0nQug0bAkV%2FgWYEYrziFLkzRomPvJSGDNHpwb6peEgKF5g4GJGCx3qCurJLfQPIC0AnVFKhpoWvaa%2FLQL6ChC6wGDy6Tl4OOwSd%2FOSuJCnSq1CwWZzdKfyQ3%2FDgDtgklpCj5%2FeQ53M5BpI6bTmGvzUZjPOclF5%2Brk%2BemsD13H7ZHfb96cFvwLHSHT62xRD0NXavKkuuUbg6LMZnfAUOCCZaZmBR2hjJCA9pJ0xHeRcvfG6FoXGmUapCjaCdA4pe1w1dwvfbrvpL4x2tCA%2Bf6zSRP427wTuP50SgkLkxX05dtO4svq%2BPfjeeMMqWgotYcj%2FN%2FVBQbQBRszE8Iw8WK1KakxxWqjDf%2BbioBjqyAe46EFyZlnjpkAH7Kxwo2RjFWK1UspOuXEko65zIpUW0G3QveRljnTHuFnmELUOY%2FbuoPKctkCKm4MSlL4vdbCrHPpvodCNBNct%2B0piCNeqN4cIPMf7KzWsae1GnSb7AF3GE0%2F8QNvzYw3DDJv0zie%2F87QMf%2FxeBFJFnoI1vuhAwg3Nhex5lw1vtQrfVTrYy%2F9P2yDEji39vZEEsb9yVzOIzAXuAyTq%2F%2F9TNfW%2Bn16NAsB8%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=f26ea8db43d4766f3a5b8974b4ba640c23125cd7a6c23fdeaaff6a3783117b17",
      "file_size": 7948534,
      "type": "video/mp4",
      "moderated": null
    }
  ],
  "allow_singular_disclosure_at": "2020-12-06T16:20:55.817Z",
  "allow_singular_disclosure_after": -88182018.68103653,
  "singular_disclosure_allowed": true,
  "vote_count": 2,
  "voters": [
    "helphen",
    "mrbeast123"
  ],
  "severity": {
    "rating": "high",
    "score": 7.4,
    "author_type": "User",
    "metrics": {
      "attack_vector": "local",
      "attack_complexity": "low",
      "privileges_required": "high",
      "user_interaction": "required",
      "scope": "changed",
      "confidentiality": "high",
      "integrity": "high",
      "availability": "none"
    }
  },
  "structured_scope": {
    "databaseId": 13,
    "asset_type": "SOURCE_CODE",
    "asset_identifier": "nextcloud/server",
    "max_severity": "critical"
  },
  "abilities": {
    "assignable_team_members": [

    ],
    "assignable_team_member_groups": [

    ]
  },
  "activities": [
    {
      "id": 6254879,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Thanks a lot for reporting this potential issue back to us!\n\nOur security team will take a look at this issue as soon as possible. We will reply to your report within 72 hours, usually much faster. For obvious reasons we'd like to ask you to not disclose this issue to any other party.",
      "automated_response": true,
      "created_at": "2019-11-08T14:19:09.476Z",
      "updated_at": "2019-11-08T14:19:09.476Z",
      "actor": {
        "url": "/nextcloud",
        "ibb": false,
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/tnqlkt8d6fcch8hj8brdjp8nw864/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "profile": {
          "name": "Nextcloud"
        }
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 6278213,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "> Administrative access to the actual Nextcloud server is not necessary to mount this attack.\n\nFirst of all, having access to the file system where Nextcloud runs is actually \"having administrative access\", as you can simply add a user which is part of the admin group.\n\n> The mentioned attack scenarios may also be executed by an external storage provider if the folder that is used as the data directory is stored at this external storage provider.\n\nOur idea for this problem is to allow to change the location of the key storage.\nCheck https://docs.nextcloud.com/server/17/admin_manual/configuration_files/encryption_configuration.html#occ-encryption-commands\n> ```\n> occ encryption:show-key-storage-root\n> Current key storage root:  default storage location (data/)\n> ```\n> Move keys to a different folder, either locally or on a different server. The folder must already exist, be owned by root and your HTTP group, and be restricted to root and your HTTP group. Further the folder needs to be located somewhere in your Nextcloud data folder, either physically, or as a mount. This example is for Ubuntu Linux. Note that the new folder is relative to your occ directory:\n\n> ```\n> cd /your/nextcloud/data\n> mkdir keys\n> chown -R root:www-data keys\n> chmod -R 0770 keys\n> occ encryption:change-key-storage-root keys\n> Start to move keys:\n>    4 [============================]\n> Key storage root successfully changed to keys\n> ```\n\n\nSo in case of an external storage being used, you would simply not put the encryption keys on the external storage, but leave them on your save Nextcloud server.\n\nI will have a closer look at the user-key scenario again.\n",
      "automated_response": false,
      "created_at": "2019-11-11T15:14:34.204Z",
      "updated_at": "2019-11-11T15:14:34.204Z",
      "actor": {
        "username": "nickvergessen",
        "cleared": false,
        "verified": false,
        "url": "/nickvergessen",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 6319768,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Hi, I know had time to look at this again. Your documentation says:\n\n> Further the folder needs to be located somewhere in your Nextcloud data folder, either physically, or as a mount.\n\nSo your idea for this problem wouldn't work in cases where the whole data directory is stored at an external party as - according to the documentation - the keys have to reside in the data directory.",
      "automated_response": false,
      "created_at": "2019-11-15T20:25:09.218Z",
      "updated_at": "2019-11-15T20:25:09.218Z",
      "actor": {
        "username": "yahe",
        "cleared": false,
        "verified": false,
        "url": "/yahe",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 6402924,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "I like the idea of storing the fingerprints in the database and comparing them.\nI'll see what I can do. But it might take a while as the 18 wrap up is consuming a lot of time.",
      "automated_response": false,
      "created_at": "2019-11-25T19:45:12.472Z",
      "updated_at": "2019-11-25T19:45:12.472Z",
      "actor": {
        "username": "rullzer",
        "cleared": false,
        "verified": false,
        "url": "/rullzer",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/f4a495c04fdb224bac8ec64587537e511aa8c4925e7955bee0a19e0ed7d891dc"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 6402925,
      "is_internal": false,
      "editable": false,
      "type": "Activities::BugTriaged",
      "message": "",
      "automated_response": false,
      "created_at": "2019-11-25T19:45:19.385Z",
      "updated_at": "2019-11-25T19:45:19.385Z",
      "actor": {
        "username": "rullzer",
        "cleared": false,
        "verified": false,
        "url": "/rullzer",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/f4a495c04fdb224bac8ec64587537e511aa8c4925e7955bee0a19e0ed7d891dc"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 6829013,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Hi, I guess that now that Nextcloud 18 has been published there will be the time to look into the issues of the server-side encryption? My plan is to to submit a talk about the Nextcloud server-side encryption to the upcoming [Gulaschprogrammiernacht](https://entropia.de/GPN20) (May 21st to May 24th). This should be enough time to fix the issues.",
      "automated_response": false,
      "created_at": "2020-01-21T16:36:54.668Z",
      "updated_at": "2020-01-21T16:36:54.668Z",
      "actor": {
        "username": "yahe",
        "cleared": false,
        "verified": false,
        "url": "/yahe",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 8122990,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Hello, this issue hasn't seen any update for 4 months. We approached the end of May without a fix. Do you still intend to work on this problem?",
      "automated_response": false,
      "created_at": "2020-05-27T19:41:52.407Z",
      "updated_at": "2020-05-27T19:41:52.407Z",
      "actor": {
        "username": "yahe",
        "cleared": false,
        "verified": false,
        "url": "/yahe",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 8145186,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Hi,\n\nYes this is still on our list but right now we don't have a good way to solve it.\n\nCheers,\n--Roeland",
      "automated_response": false,
      "created_at": "2020-05-29T13:34:49.656Z",
      "updated_at": "2020-05-29T13:34:49.656Z",
      "actor": {
        "username": "rullzer",
        "cleared": false,
        "verified": false,
        "url": "/rullzer",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/f4a495c04fdb224bac8ec64587537e511aa8c4925e7955bee0a19e0ed7d891dc"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 8901172,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Hi,\n\nSo I'm back form my holiday and am continuing on https://github.com/nextcloud/server/pull/21529\n\nSince keys can be moved for files etc. Linking the data in the database is tricky. However in this new approach the keys are encrypted with the system secret. And hence the attacker can't modify them.\n\nWould you have the possibility to check out that PR?\n\nCheers,\n--Roeland",
      "automated_response": false,
      "created_at": "2020-08-11T07:49:48.701Z",
      "updated_at": "2020-08-11T07:49:48.701Z",
      "actor": {
        "username": "rullzer",
        "cleared": false,
        "verified": false,
        "url": "/rullzer",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/f4a495c04fdb224bac8ec64587537e511aa8c4925e7955bee0a19e0ed7d891dc"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 8903396,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "I think that the solution goes in the right direction, but I see a certain flow: If I understand it correctly, it is still possible to replace the public key of one user with the public key of another user. So the given solution improves on the currently existing problem but does not completely fix it.\n\nUnfortunately, you currently have no possibility to have integrity-protected metadata for public key files. If you switched the process around to: `encrypt(json_encode($data))` you could have integrity-protected metadata. Then, a possibility to fix this problem completely would be to not only introduce the `$data[\"key\"]` value but also a `$data[\"user\"]` value containing the name of the associated user. This could be checked on usage to make sure that the key actually belongs to the correct user. Thanks to the EtM encryption taking place at the end, the key as well as the metadata would be integrity-protected.",
      "automated_response": false,
      "created_at": "2020-08-11T10:32:54.033Z",
      "updated_at": "2020-08-11T10:32:54.033Z",
      "actor": {
        "username": "yahe",
        "cleared": false,
        "verified": false,
        "url": "/yahe",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 8908306,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Hi,\n\nThanks for the quick analysis.\nRight turning it around would indeed make more sense. Let me do that.\n\nI need to think about your comment. I think you are right and we can indeed store the user key with the uid.\nIn any case with this in place the attack scopes limits significantly in the sense that the attacker now must have an account on the system and access to the external storage. However lets fix it properly now that we are touching the code in any case.\n\nI need a break now since it is way to hot here. I'll get back to you tomorrow.\n\nCheers,\n--Roeland\n",
      "automated_response": false,
      "created_at": "2020-08-11T17:02:46.432Z",
      "updated_at": "2020-08-11T17:02:46.432Z",
      "actor": {
        "username": "rullzer",
        "cleared": false,
        "verified": false,
        "url": "/rullzer",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/f4a495c04fdb224bac8ec64587537e511aa8c4925e7955bee0a19e0ed7d891dc"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 8914908,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Hi,\n\nI updated the PR. Now it also stores the UID in the userkeys  (and null in the systemkeys). This is then all encrypted.\nIt needs some cleanup but I think this now goes in the right direction.\n\nCheers,\n--Roeland",
      "automated_response": false,
      "created_at": "2020-08-12T11:12:58.744Z",
      "updated_at": "2020-08-12T11:12:58.744Z",
      "actor": {
        "username": "rullzer",
        "cleared": false,
        "verified": false,
        "url": "/rullzer",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/f4a495c04fdb224bac8ec64587537e511aa8c4925e7955bee0a19e0ed7d891dc"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 8915645,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Hi, I had a short look at the current version in the PR. IMHO this is coming together quite nicely.\n\nI am, however, a bit confused with the additional encodings going on. Of course, you may have certain reasons to double- and tripple-encode data, but I just wanted to mention what I see. I stumbled over this kind of (in my opinion) unnecessary file increases before with the 35% size-increase of the encrypted content files.:\n\n* Currently, the public keys stored by the SSE are PEM-encoded (which is basically Base64-Encoding between text separators with line breaks). That's the formatting you retrieve [here](https://github.com/nextcloud/server/blob/aa387242e110555e6ff6058985b40a040f9c1540/lib/private/Encryption/Keys/Storage.php#L275) and write [here](https://github.com/nextcloud/server/blob/aa387242e110555e6ff6058985b40a040f9c1540/lib/private/Encryption/Keys/Storage.php#L340). Instead of Base64-encoding the whole data again, you could just replace the line breaks with a placeholder like `'\\n'`, but that's more of a taste.\n* What I don't understand is why you Base64-encode the encrypted content again before storing it in a file [here](https://github.com/nextcloud/server/blob/aa387242e110555e6ff6058985b40a040f9c1540/lib/private/Encryption/Keys/Storage.php#L343) only to Base64-decode it [here](https://github.com/nextcloud/server/blob/aa387242e110555e6ff6058985b40a040f9c1540/lib/private/Encryption/Keys/Storage.php#L299) when you read the file back in. I really don't see the benefit of this additional Base64-encoding. `file_get_contents()` and `file_put_contents()` are perfectly able to handle binary data without precautionary encoding.\n\nBut, as I said, this is more of an observation rather than a security issue.",
      "automated_response": false,
      "created_at": "2020-08-12T12:15:52.570Z",
      "updated_at": "2020-08-12T12:15:52.570Z",
      "actor": {
        "username": "yahe",
        "cleared": false,
        "verified": false,
        "url": "/yahe",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 8915664,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Hi,\n\nNo you are of course right. It is a left over I think from the first step where I encrypted only the key field (so that the json encode would not puke).\n\nThis can go indeed.\nI'll tackle that in a bit.\n\nCheers,\n--Roeland",
      "automated_response": false,
      "created_at": "2020-08-12T12:18:31.746Z",
      "updated_at": "2020-08-12T12:18:31.746Z",
      "actor": {
        "username": "rullzer",
        "cleared": false,
        "verified": false,
        "url": "/rullzer",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/f4a495c04fdb224bac8ec64587537e511aa8c4925e7955bee0a19e0ed7d891dc"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 8924632,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Hi,\n\nOk we went over the code here again and some cleanup was done.\nNow we are in the process of doing lot of tests but all seems good. I'm positive this can land in thenext release.\n\nCheers,\n--Roeland",
      "automated_response": false,
      "created_at": "2020-08-13T10:47:40.193Z",
      "updated_at": "2020-08-13T10:47:40.193Z",
      "actor": {
        "username": "rullzer",
        "cleared": false,
        "verified": false,
        "url": "/rullzer",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/f4a495c04fdb224bac8ec64587537e511aa8c4925e7955bee0a19e0ed7d891dc"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 8924764,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Awesome to hear that. :)",
      "automated_response": false,
      "created_at": "2020-08-13T10:59:49.947Z",
      "updated_at": "2020-08-13T10:59:49.947Z",
      "actor": {
        "username": "yahe",
        "cleared": false,
        "verified": false,
        "url": "/yahe",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9021073,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Hi,\n\nOk this got merged into 20.\nIt is already in the beta1.\n\nCheers,\n--Roeland",
      "automated_response": false,
      "created_at": "2020-08-24T10:46:33.930Z",
      "updated_at": "2020-08-24T10:46:33.930Z",
      "actor": {
        "username": "rullzer",
        "cleared": false,
        "verified": false,
        "url": "/rullzer",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/000/086/005/20095c4a0c77c88375f8db5d6ed10f350d98a5a3_original.jpg/f4a495c04fdb224bac8ec64587537e511aa8c4925e7955bee0a19e0ed7d891dc"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9423161,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Hi, I've seen that you have announced Nextcloud 20 that contains the fix for this issue. Will there be a [security advisory](https://nextcloud.com/security/advisories/) for this issue?",
      "automated_response": false,
      "created_at": "2020-10-05T16:18:55.135Z",
      "updated_at": "2020-10-05T16:18:55.135Z",
      "actor": {
        "username": "yahe",
        "cleared": false,
        "verified": false,
        "url": "/yahe",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9429784,
      "is_internal": false,
      "editable": false,
      "type": "Activities::BugResolved",
      "message": "Thanks a lot for your report again. This has been resolved in our latest maintenance releases and we're working on the advisories at the moment.\n\nPlease let us know how you'd like to be credited in our official advisory. We require the following information:\n\n- Name / Pseudonym\n- Email address (optional)\n- Website (optional)\n- Company (optional)\n",
      "automated_response": false,
      "created_at": "2020-10-06T08:05:03.428Z",
      "updated_at": "2020-10-06T08:05:03.428Z",
      "actor": {
        "username": "nickvergessen",
        "cleared": false,
        "verified": false,
        "url": "/nickvergessen",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "reporter": {
        "username": "yahe",
        "url": "/yahe"
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9429820,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Disclosure planned for 1st November\n\nhttps://nextcloud.com/security/advisory/?id=NC-SA-2020-041\nhttps://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8159\n",
      "automated_response": false,
      "created_at": "2020-10-06T08:09:39.931Z",
      "updated_at": "2020-10-06T08:09:39.931Z",
      "actor": {
        "username": "nickvergessen",
        "cleared": false,
        "verified": false,
        "url": "/nickvergessen",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9429821,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "@yahe do you still not want bounties?",
      "automated_response": false,
      "created_at": "2020-10-06T08:09:58.738Z",
      "updated_at": "2020-10-06T08:09:58.738Z",
      "actor": {
        "username": "nickvergessen",
        "cleared": false,
        "verified": false,
        "url": "/nickvergessen",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9431774,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "As said, merch would be welcome. :)",
      "automated_response": false,
      "created_at": "2020-10-06T10:09:49.417Z",
      "updated_at": "2020-10-06T10:09:49.417Z",
      "actor": {
        "username": "yahe",
        "cleared": false,
        "verified": false,
        "url": "/yahe",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9431872,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Concerning the crediting in the advisory:\n\nName: Kevin \"Kenny\" Niehage\nE-Mail: kenny@syseleven.de\nWebsite: https://www.syseleven.de/\nCompany: SysEleven GmbH",
      "automated_response": false,
      "created_at": "2020-10-06T10:21:32.714Z",
      "updated_at": "2020-10-06T10:21:32.714Z",
      "actor": {
        "username": "yahe",
        "cleared": false,
        "verified": false,
        "url": "/yahe",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9442067,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "[CVE-2020-8159](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8159) is already taken. Maybe that's just a typo.",
      "automated_response": false,
      "created_at": "2020-10-07T06:57:03.182Z",
      "updated_at": "2020-10-07T06:57:03.182Z",
      "actor": {
        "username": "yahe",
        "cleared": false,
        "verified": false,
        "url": "/yahe",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9443497,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Right, it's https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-8259\n",
      "automated_response": false,
      "created_at": "2020-10-07T08:50:54.403Z",
      "updated_at": "2020-10-07T08:50:54.403Z",
      "actor": {
        "username": "nickvergessen",
        "cleared": false,
        "verified": false,
        "url": "/nickvergessen",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9730350,
      "is_internal": false,
      "editable": false,
      "type": "Activities::Comment",
      "message": "Good morning. Do you already know when the CVE and NC-SA will be published?",
      "automated_response": false,
      "created_at": "2020-11-05T08:07:23.210Z",
      "updated_at": "2020-11-05T08:07:23.210Z",
      "actor": {
        "username": "yahe",
        "cleared": false,
        "verified": false,
        "url": "/yahe",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9749069,
      "is_internal": false,
      "editable": false,
      "type": "Activities::AgreedOnGoingPublic",
      "message": "",
      "automated_response": false,
      "created_at": "2020-11-06T16:20:55.781Z",
      "updated_at": "2020-11-06T16:20:55.781Z",
      "first_to_agree": true,
      "actor": {
        "username": "yahe",
        "cleared": false,
        "verified": false,
        "url": "/yahe",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/0lg7nic0d0quts8mwr9b7bqk56rl/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9814689,
      "is_internal": false,
      "editable": false,
      "type": "Activities::AgreedOnGoingPublic",
      "message": "SA published, CVE should autopublish when this is disclosed.",
      "automated_response": false,
      "created_at": "2020-11-13T14:39:41.088Z",
      "updated_at": "2020-11-13T14:39:41.088Z",
      "actor": {
        "username": "nickvergessen",
        "cleared": false,
        "verified": false,
        "url": "/nickvergessen",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 9814690,
      "is_internal": false,
      "editable": false,
      "type": "Activities::ReportBecamePublic",
      "message": "",
      "automated_response": false,
      "created_at": "2020-11-13T14:39:41.239Z",
      "updated_at": "2020-11-13T14:39:41.239Z",
      "actor": {
        "username": "nickvergessen",
        "cleared": false,
        "verified": false,
        "url": "/nickvergessen",
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/5DBbeB7om4ZiKgskrEoeTyGH/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "hackerone_triager": false,
        "hackerone_employee": false
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    },
    {
      "id": 10423189,
      "is_internal": false,
      "editable": false,
      "type": "Activities::NotEligibleForBounty",
      "message": "Setting to \"ineligible\" as you didn't want a bounty, but this closes the tickets cycle in the H1 workflow.",
      "automated_response": false,
      "created_at": "2021-01-20T12:42:41.563Z",
      "updated_at": "2021-01-20T12:42:41.563Z",
      "actor": {
        "url": "/nextcloud",
        "ibb": false,
        "profile_picture_urls": {
          "medium": "https://profile-photos.hackerone-user-content.com/variants/tnqlkt8d6fcch8hj8brdjp8nw864/5136ed9b2fa7c4d4abbf39fb971047c62d98ec4740a88eb55d7e26373250a937"
        },
        "profile": {
          "name": "Nextcloud"
        }
      },
      "genius_execution_id": null,
      "team_handle": "nextcloud"
    }
  ],
  "activity_page_count": 1,
  "activity_page_number": 1,
  "summaries": [
    {
      "category": "team",
      "can_view?": true,
      "can_create?": false
    },
    {
      "category": "researcher",
      "can_view?": true,
      "can_create?": false
    }
  ]
}